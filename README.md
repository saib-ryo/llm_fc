# LLMアプリケーション解説

## 機能
このアプリケーションは旅行計画を支援するLLMベースのツールです。ユーザー入力から旅行先、日程、ホテル情報を抽出し、以下を行います：
- **旅行日程の抽出**（到着・出発日時、滞在日数）
- **ホテル候補の推定・重複排除・距離計算**
- **天気情報の取得**（OpenWeather API）
- **観光スポットやナイトライフ情報の生成**（LLM経由）
- **旅行プラン自動生成**（天気・ホテル・フライト制約を踏まえた提案）

---

## 使用している外部API
- **OpenWeather One Call API**: 指定した場所の週間天気を取得。
- **Open-Meteo Geocoding API**: 地名から緯度・経度を取得。
- **OpenAI Chat Completions API**:  
  - ユーザー入力の解析（location, days, arrival_time, departure_time）  
  - ホテル候補の取得  
  - 観光スポット情報生成  
  - 旅行プラン生成  

---

## 関数の説明
- **haversine(lat1, lon1, lat2, lon2)**  
  緯度・経度から距離を計算する関数。

- **get_hotel_candidates_via_llm(hotel_name, location, …)**  
  LLMを利用し、ホテル名と地域から候補を取得。類似度スコアを返す。

- **deduplicate_hotels(candidates, …)**  
  ホテル候補の重複排除を行う。文字列類似度と座標の閾値を使う。

- **get_coordinates(location: str)**  
  Open-Meteo APIで地名から座標を取得。

- **get_weather(location: str, days: int = 7)**  
  OpenWeather APIを利用し週間天気を返す。

- **get_tourist_spots(location: str, limit: int = 12)**  
  LLMを使って観光スポット・ナイトライフ・料理をJSON形式で返す。

- **main処理**  
  1. ユーザーから旅行内容を入力  
  2. LLMで日程情報を抽出  
  3. ホテル候補をLLMから取得し、重複を排除してユーザーに選択させる  
  4. 天気と観光スポットを取得  
  5. LLMに情報を渡し、旅行プランを生成  

---

## 全体の流れ
1. ユーザーが旅行内容（場所・期間）を入力  
2. ChatGPTが到着日・出発日・滞在日数を抽出  
3. ユーザーが宿泊ホテルを入力し、候補が提示される（距離や類似度でスコアリング）  
4. 天気情報と観光スポットを収集  
5. これらをまとめてLLMに渡し、日ごとのプランを生成  
6. プランには服装アドバイス、午前・午後・夜のアクティビティ、地元料理の提案が含まれる  

---

## プロンプト設定（content例）
旅行プラン生成時の **system プロンプト** では以下を指定：  
- 各Dayの冒頭に天気情報と服装アドバイスを含める  
- 午前・午後・夜の3分割でアクティビティを提案  
- 夜は毎日異なる地元料理を提案  
- 初日は到着時刻以前に活動を入れない  
- 最終日は出発時刻とチェックイン制約を考慮する  
- 宿泊ホテルがある場合は「ホテル出発」「ホテルに戻る」を含める  
- 最後に持ち物リストをまとめる  

---

この仕組みにより、旅行者にとってリアルな条件を考慮した多様で実用的な旅行プランを提供できます。
